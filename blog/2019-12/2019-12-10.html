<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>常用前端知识总结 | promise与settime的执行顺序,</title>
    <meta name="description" content="探究宏任务与微任务的执行顺序">
    <link rel="shortcut icon" href="./favicon.ico">
    
    <link rel="preload" href="/myBlog/assets/css/0.styles.56354200.css" as="style"><link rel="preload" href="/myBlog/assets/js/app.02882a5d.js" as="script"><link rel="preload" href="/myBlog/assets/js/5.dc2a9d81.js" as="script"><link rel="prefetch" href="/myBlog/assets/js/1.18f693a2.js"><link rel="prefetch" href="/myBlog/assets/js/2.4bb8f7e8.js"><link rel="prefetch" href="/myBlog/assets/js/3.9b203686.js"><link rel="prefetch" href="/myBlog/assets/js/4.ccdcf3f6.js"><link rel="prefetch" href="/myBlog/assets/js/6.9f7ad172.js"><link rel="prefetch" href="/myBlog/assets/js/7.e9ee2551.js"><link rel="prefetch" href="/myBlog/assets/js/8.8a192da9.js"><link rel="prefetch" href="/myBlog/assets/js/9.4ae8ca22.js"><link rel="prefetch" href="/myBlog/assets/js/10.37868b46.js"><link rel="prefetch" href="/myBlog/assets/js/11.675ab4f9.js">
    <link rel="stylesheet" href="/myBlog/assets/css/0.styles.56354200.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/myBlog/" class="home-link router-link-active"><img src="/myBlog/logo.png" class="logo"><span class="site-name can-hide">
      常用前端知识总结
    </span></a><div class="links"><nav class="nav-links can-hide"><div class="nav-item"><a href="/myBlog/" class="nav-link">博客列表</a></div><div class="nav-item"><a href="/myBlog/about/" class="nav-link">关于</a></div><!----></nav><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/myBlog/" class="nav-link">博客列表</a></div><div class="nav-item"><a href="/myBlog/about/" class="nav-link">关于</a></div><!----></nav><ul class="sidebar-links"><li><a href="/myBlog/blog/2019-12/2019-12-10.html" class="active sidebar-link">博客目录</a><ul class="sidebar-sub-headers"></ul></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>2019-12博客汇总</span><span class="arrow down"></span></p><ul class="sidebar-group-items"><li><a href="/myBlog/blog/2019-12/2019-12-10.html" class="active sidebar-link">执行顺序</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/myBlog/blog/2019-12/2019-12-12.html" class="sidebar-link">yarn常用命令</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>2020-01博客汇总</span><span class="arrow right"></span></p><!----></div></li></ul></div><div class="page"><div class="content"><h3 id="什么是宏任务-macrotasks-和微任务-microtasks"><a href="#什么是宏任务-macrotasks-和微任务-microtasks" aria-hidden="true" class="header-anchor">#</a> 什么是宏任务(Macrotasks)和微任务(Microtasks)</h3><p>首先我们应该知道JavaScript 是单线程的脚本语言(在执行某一段代码的时候是不会同时执行另一段代码的)。</p><p>如果所有的代码都同步执行的话会有什么结果呢，比如当程序向后台发送了一个请求，此时你能做的只有双手合十祈祷网速快一点，因为程序只有在得到后台回应的时候才会执行其他的操作。</p><p>于是就出现了异步事件的概念，当程序向后台发送一个请求以后，可以做一些其他的事，即使请求返回的数据程序已经拿到了，也需要等到程序做完正在做的事，才会处理请求返回的数据，这就是异步事件。</p><p>而异步任务又分为宏任务和微任务，其中微任务的优先级高于宏任务。</p><p>宏任务有: setTimeout, setInterval, setImmediate(node中),requestAnimationFrame(浏览器)；</p><p>微任务有：process.nextTick(node中), MutationObserver(浏览器)，catch, finally, Promise.then。</p><p>其中需要注意的是Promise中的函数遇到立即执行，只有promise所对应的then中执行的代码片段需要加入‘微任务’队列(队列遵循先进先出原则)。</p><p>总结经验就是：全局的js语句与promise中的语句顺序执行(遇到就执行)，而宏任务遇到需放入宏任务队列，遇到微任务则放入微任务队列，当前代码溜了一遍之后(之所以说溜了一遍是因为并不是严格意义上的代码执行完毕了)，再将微任务中的代码块按顺序执行，当执行完队列中的所有微任务，就进入宏任务队列依次执行宏任务代码块。</p><p><img src="https://img-blog.csdnimg.cn/20191205180241296.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzIxMzk3ODE1" alt="my-logo.png" title="my-logo"></p><h3 id="实例演练"><a href="#实例演练" aria-hidden="true" class="header-anchor">#</a> 实例演练</h3><h4 id="_1-单个的宏任务或微任务"><a href="#_1-单个的宏任务或微任务" aria-hidden="true" class="header-anchor">#</a> 1.单个的宏任务或微任务</h4><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><blockquote><p>输出答案为：start -&gt; end -&gt; setTimeout</p></blockquote><p>解析： 普通js代码遇到就直接执行，宏任务需先放入宏任务队列，到当前环境代码溜一遍之后发现微任务队列里面没有需要执行的代码块，则执行宏任务。</p><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'then'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><blockquote><p>输出答案为：start -&gt; promise -&gt; end -&gt; then</p></blockquote><p>解析：普通js代码遇到就直接执行，微任务需先放入微任务队列，到当前环境代码溜一遍之后执行微任务中的代码，然后发现宏任务队列里面没有代码块需要执行，则整个代码执行完毕。</p><p>如果你上面的两个题都做对了，那恭喜你已经将理论与实践结合起来了，但是想要进一步理解，需要通过下一个题目来检验。</p><p>当然如果你没有回答正确请不要灰心，可以喝口水缓缓，然后从头再梳理一遍。</p><h4 id="_2-宏任务和微任务混搭："><a href="#_2-宏任务和微任务混搭：" aria-hidden="true" class="header-anchor">#</a> 2. 宏任务和微任务混搭：</h4><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'then1'</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1 end'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'middle'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout1'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise2'</span><span class="token punctuation">)</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'then2'</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise2 end'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><blockquote><p>输出答案为：start -&gt; promise1 -&gt; promise1 end -&gt; middle -&gt; promise2 -&gt; promise2 end -&gt; end -&gt; then1 -&gt; then2 -&gt; timeout1。</p></blockquote><p>解析：先输出start,然后输出promise1，再输出promise1 end 我就得你应该已经明白为什么了，那我们接下来从这里开始分析，此时应该在微任务队列中放入 then第一个promise对应的then语句；遇到middle，直接执行，timeout 放入宏任务队列；遇到第二个promise，直接执行promise中的语句，然后将对应的then中的代码块放入微任务队列，成为微任务2号；在执行end。到目前为止，所有的代码都溜了一遍了，下面先依次执行微任务列表中的代码块，为then1,then2,最后执行宏任务timeout1。</p><p>怎么样，你有没有get到关键所在呢，接下来就要放大招了，你准备好了吗？</p><h4 id="_3-每个promise对应多个then方法"><a href="#_3-每个promise对应多个then方法" aria-hidden="true" class="header-anchor">#</a> 3.每个promise对应多个then方法</h4><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout1'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1 start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'promise1 end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise2 start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'promise2 end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'finish'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><blockquote><p>输出答案：start -&gt; promise1 start -&gt; promise2 start -&gt; finish -&gt; promise1 end 1 -&gt; promise3 -&gt; promise2 end 1 -&gt; promise4 -&gt; promise1 end 2 -&gt; promise2 end 2 -&gt; timeout1</p></blockquote><p>解析：具体运行步骤如下：</p><p>① 执行一遍全局代码：</p><p>start: 输出start -&gt; timeout1: 将timeout1放入宏任务队列 -&gt; promise1: 输出promise1 start -&gt; then1.1: 将then1.1放入微任务队列 -&gt; promise2: 输出promise2 start -&gt; then2.1: 将then2.1放入微任务队列 -&gt; finish:输出finish
    执行完毕时，各队列及输出如下：</p><p>宏任务队列：[ 'timeout1' ]
        微任务队列： [ 'then1.1', 'then2.1' ]
        输出：start -&gt; promise1 start -&gt; promise2 start -&gt; finish</p><p>② 执行微任务队列中的第一位：</p><p>执行then1.1：输出 promise1 end 1 -&gt; promise3: 输出promise3-&gt; then1.2: 将then1.2 放入微任务队列
    执行完毕时，各队列及输出如下：</p><p>宏任务队列：[ 'timeout1' ]
        微任务队列： [ 'then2.1', 'then1.2' ]
        输出：start -&gt; promise1 start -&gt; promise2 start -&gt; finish -&gt; promise1 end 1 -&gt; promise3</p><p>③ 执行微任务队列中的第一位：</p><p>执行then2.1：输出 promise2 end 1 -&gt; promise4: 输出promise4 -&gt; then2.2: 将then2.2 放入微任务队列
    执行完毕时，各队列及输出如下：
        宏任务队列：[ 'timeout1' ]
        微任务队列： [ 'then1.2', 'then2.2' ]
        输出：start -&gt; promise1 start -&gt; promise2 start -&gt; finish -&gt; promise1 end 1 -&gt; promise3 -&gt; promise2 end 1 -&gt; promise4</p><p>④ 执行微任务队列中的第一位：</p><p>执行then1.2：直接输出 promise1 end 2
    执行完毕时，各队列及输出如下：
        宏任务队列：[ 'timeout1' ]
        微任务队列： [ 'then2.2' ]
        输出：start -&gt; promise1 start -&gt; promise2 start -&gt; finish -&gt; promise1 end 1 -&gt; promise3 -&gt; promise2 end 1 -&gt; promise4 -&gt; promise1 end 2</p><p>⑤ 执行微任务队列中的第一位：</p><p>执行then2.2：直接输出 promise2 end 2
    执行完毕时，各队列及输出如下：
        宏任务队列：[ 'timeout1' ]
        微任务队列： []
        输出：start -&gt; promise1 start -&gt; promise2 start -&gt; finish -&gt; promise1 end 1 -&gt; promise3 -&gt; promise2 end 1 -&gt; promise4 -&gt; promise1 end 2 -&gt; promise2 end 2</p><p>⑥ 检查微任务队列：</p><p>此时微任务队列为空，则进行下一步</p><p>⑦ 执行宏任务队列中的第一位：</p><p>执行timeout1： 直接输出timeout1
    执行完毕时，各队列及输出如下：
        宏任务队列：[]
        微任务队列： []
        输出：start -&gt; promise1 start -&gt; promise2 start -&gt; finish -&gt; promise1 end 1 -&gt; promise3 -&gt; promise2 end 1 -&gt; promise4 -&gt; promise1 end 2 -&gt; promise2 end 2 -&gt; timeout1</p><p>此时，整段代码执行完毕，最终输出结果如下：</p><p>start -&gt; promise1 start -&gt; promise2 start -&gt; finish -&gt; promise1 end 1 -&gt; promise3 -&gt; promise2 end 1 -&gt; promise4 -&gt; promise1 end 2 -&gt; promise2 end 2 -&gt; timeout1</p><p></p><p>答对了不要高兴得太早呀，终极大挑战等着你呢！come on</p><h4 id="_4-宏任务与微任务嵌套"><a href="#_4-宏任务与微任务嵌套" aria-hidden="true" class="header-anchor">#</a> 4. 宏任务与微任务嵌套</h4><pre class="language-js"><code><span class="token comment">// 我为所有的语句标了代号，以便后面解析使用</span>
<span class="token comment">// timeout1</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// timeout2</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// promise1</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// then1</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// promise2</span>
        <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// then2</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// here</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'here'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// timeout3</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout3'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// timeout4</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout4'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// promise3</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// then3</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><blockquote><p>输出答案为：promise3 -&gt; then3 -&gt; timeout1 -&gt; timeout2 -&gt; promise1 -&gt; then1 -&gt; promise2 -&gt; here -&gt; then2 -&gt; timeout4 -&gt; timeout3</p></blockquote><p>解析：具体执行步骤如下：</p><p>① 执行一遍整体代码：</p><p>执行过程：</p><p>timeout1: 入宏任务队列 -&gt; timeout2: 入宏任务队列 -&gt; timeout4入宏任务队列 -&gt; promise3:输出‘promise3’ -&gt; then3: 入微任务队列。</p><p>此时各队列和输出如下：
        宏任务队列：[ 'timeout1', 'timeout2', 'timeout4' ]
        微任务队列：['then3']</p><p>输出：promise3</p><p>② 执行当前微任务队列：</p><p>then3：直接输出then3</p><p>执行完毕时：</p><p>宏任务队列：[ 'timeout1', 'timeout2', 'timeout4' ]</p><p>微任务队列：[]</p><p>输出：promise3 -&gt; then3</p><p>③ 执行宏任务队列排在第一位的代码块：</p><p>宏任务队列中排在第一位的为timeout1,比较简单，直接输出timeout1就好。</p><p>执行完毕时：</p><p>宏任务队列：[ 'timeout2', 'timeout4' ]</p><p>微任务队列：[]</p><p>输出：promise3 -&gt; then3 -&gt; timeout1</p><p>④ 检查当前微任务队列：</p><p>当前微任务队列为空，则继续执行宏任务队列中第一位的代码块。</p><p>⑤ 执行宏任务队列排在第一位的代码块(其实就是重复上面的步骤，但是过程中需要谨慎)</p><p>执行一遍宏任务队列中排在第一位的代码块timeout2，过程如下：
        输出timeout2 -&gt; promise1: 输出promise1-&gt; then1: 放入微任务队列 -&gt; timeout3：放入宏任务队列</p><p>此时：</p><p>宏任务队列：['timeout4', 'timeout3']</p><p>微任务队列：[ 'then1' ]</p><p>输出：promise3 -&gt; then3 -&gt; timeout1 -&gt; timeout2 -&gt; promise1</p><p>⑥ 执行当前微任务队列中的代码块</p><p>执行then1过程如下：
        输出then1-&gt; promise2：输出promise2 -&gt; then2: 放入微任务队列 -&gt; here: 输出here</p><p>执行完毕时：</p><p>宏任务队列：[ 'timeout4', 'timeout3']
        微任务队列：['then2']
        输出：promise3 -&gt; then3 -&gt; timeout1 -&gt; timeout2 -&gt; promise1 -&gt; then1 -&gt; promise2 -&gt; here</p><p>⑦ 执行微任务队列的代码块</p><p>执行then2: 直接输出then2</p><p>此时：</p><p>宏任务队列：['timeout4', 'timeout3']
        微任务队列：[]
        输出：promise3 -&gt; then3 -&gt; timeout1 -&gt; timeout2 -&gt; promise1 -&gt; then1 -&gt; promise2 -&gt; here -&gt; then2</p><p>⑧ 检查微任务队列</p><p>此时微任务队列中没有需要执行的代码块，进行下一步，执行宏任务队列中的第一位</p><p>⑨ 执行宏任务队列中排在第一位的代码块</p><p>执行timeout4：直接输出timeout4</p><p>此时：</p><p>宏任务队列：['timeout3']
        微任务队列：[]
        输出：promise3 -&gt; then3 -&gt; timeout1 -&gt; timeout2 -&gt; promise1 -&gt; then1 -&gt; promise2 -&gt; here -&gt; then2 -&gt; timeout4</p><p>⑩ 检查微任务队列</p><p>此时微任务队列中没有需要执行的代码块，进行下一步，执行宏任务队列中的第一位</p><p>⑪ 执行宏任务队列中排在第一位的代码块</p><p>执行timeout3：直接输出timeout3</p><p>任务队列中排在第一位的代码块</p><p></p><p>执行timeout3：直接输出timeout3</p><p>此时：</p><p>宏任务队列： []</p><p>微任务队列：[]</p><p>输出：promise3 -&gt; then3 -&gt; timeout1 -&gt; timeout2 -&gt; promise1 -&gt; then1 -&gt; promise2 -&gt; here -&gt; then2 -&gt; timeout4 -&gt; timeout3</p><p>至此，整个程序完执行完毕，因此最终输出为：</p><p>promise3 -&gt; then3 -&gt; timeout1 -&gt; timeout2 -&gt; promise1 -&gt; then1 -&gt; promise2 -&gt; here -&gt; then2 -&gt; timeout4 -&gt; timeout3</p></div><!----><div class="content page-nav"><p class="inner"><!----><span class="next"><a href="/myBlog/blog/2019-12/2019-12-10.html" class="router-link-exact-active router-link-active">
          执行顺序
        </a> →
      </span></p></div></div></div></div>
    <script src="/myBlog/assets/js/5.dc2a9d81.js" defer></script><script src="/myBlog/assets/js/app.02882a5d.js" defer></script>
  </body>
</html>
